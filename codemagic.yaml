workflows:
  ios-workflow:
    name: iOS Workflow
    # instance_type: mac_mini
    max_build_duration: 120
    environment:
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"                
        # https://docs.codemagic.io/code-signing-yaml/signing-ios/
        APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmhKaDF2TDQ3WFN0c29rd2lVeXV5elhRS3htNDZjUU9ZZUt2bk5lZmFldnplSDNQd1FMaFluVWJ6djM2ZDlOa1ZDUkdnYXVVcmpDekJPdU94RDZzRDFxcVNqSVRqdnlJTUhuUVJvaVY3TjZieTJkVHdWUEcxQ0d5UFZLQ050emhIcjd6OGQ=) # <-- Put your encrypted App Store Connect Issuer Id here 
        APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmhKa1BBcjBhOHVxcklHcVY1aEJLbDlCNzZJRUtYNGx5QXBBOURyQ0x1WVFFNXpvYmF5YXNabk5BYzFES1ZQTjhKWjlSWEt0bGFsak5YWS1ldDl4RFZJSG5Bb3c9PQ==) # <-- Put your encrypted App Store Connect Key Identifier here 
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhKa2pEVzg1dlUxenpYaDdXTHJWSmFIaDl6ckkxYklaUG5MdUJKSUREMFVBTkV4X0lWOFR2ZVlJOUw4b1gwdnpVVExCUFJESHYxdkJxalRwZUtlcFkzQTczb24xRnppZWUyT2xCaDZ1ck1kM05tdjVwbk9DclJHR0dYRHd0bjlyemdYWkVDeEllbTBZZkxCU1FjeE9PWnF5RXM1ZDk3N25VRkl0eURpQ2l3Y3JzVlhSOTRYUElad281eVpBYUhyV0M3M3FEanhJZzR3Z1lUbGcwWTBoUTlnS3N1a1lQYnBIZ1QwUWpERVYtN1Mxd0Vnam1sWm0yRklLcEhVMTFkMDczdHdhOFFqQ205VVJ0UHRaYzNZVS05a1lfZ1VYVDZQN254NER6UnVDZk8tVjRudEJiUk92d0JlSnItTGVQTS1RQk5SQy1JaXo1THFYcmdRejQ5SEhHUFE3ZkhYdnpTRGFPekh0VXVVaXhEbVRXaURzUkpQX0xWaHZQNGZOM0F6NmhQNVM5Um9yZFVQQ05JVlprMkIyQlRhOC1MSkNzNkFFa291UnlXYnRhMklOUGtvWT0=) # <-- Put your encrypted App Store Connect Private Key here 
        # APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmhKa1hTb3ZSTE16WXRXNFFxalhSVGw5cU51WWFDWElMaUhNNjBmeGE1SlJjSXFvOEN4M25iYU1IZi1IckQ5dU9NanJuVWpYdzcxN0tYa1BqY3FKbG1UTVkxcXc9PQ==)
        # APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhKa1dUTmJjTFpHZlQxZGVFeWo0YVhxajJha3lGZFRWR3BGdVVGUHo3N1EyWWsyWmEwbXZZOVlpRDRScGVJOTNRbTVzR3NqTEFCOHlUdXViVzNqWnphUEhZNkRHQVVZN2VwbmlKeFJBb2x6bGU0VU91clJpMVRGbkFJdXpMMEdrWEM4NWVmcVFyMGhpRWlMVDZjamNtbC14SEVKNEd1NVVwMkJXbXI2cGdoTHlweUtwdy1ERnh0OFNGaGIyZVZ6Ykl2d3R6NHo4S2RjRzRldnhfQkFkNW5rdTczT1NZMi1Ec2p4RHBseXExeWo2SE5uVFRBREZ3WVlTSW5xYnBvOWhsdUI0MHhEWS1ibmN6MkNLek5CZVlYN0J6Sk85Q0lqN2g4OWNUN1VoTTlwVDdqV2RVNEZWeGxKY1lsU05yREZOYTlHeXdXb3owN0doWkZPUXFYZ25CcDZqQk9idDd2bjdvMVpjRmFKUno4Mm5wdDlJbUNmajhWOGN1LUZaRkdUZzhzVjl5aERwSTh6V0NQN0Q4bzBPdzNOelpqN0FyZk9hYVpGa2FWMHRkMVM0N0JYZlAwRzgyX0dsWXRIek5VUFRveEJvSmhsTk1SalVhbUVHeWJrWnc0UkdsTnI0NG9WM01FNHQ4ZWZVVmJaSXhyQVdzdmZ2bDI2UTVVRG1fZm93cURTQmVlUE1MR095NUt1cnUzcGZYQXZ4TDZBPT0=)
        CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhKaDlIa3VnMkZ6bDR6WWFiZ2xJaTFXQ202NnBvSk56R0ZpNnk5aGp0MGdLVjQybVhpZ2ZtVGJKLW1mdE5iS1ZIaWpJV1MwcGlXYVZaQzh5YlFfS0tVclRURTNqVGRzTkFhb1FfQWRLUEhkSXBjMmJvLTNubktiODU4RkVFeU1OOG4xUzFReVlPajlQUmROWHZoRlhoMDJUMW5vWEZXVW9rdV92aW1RZlNqSG5yVzlMZVVJZEszejBKY3FnR0JTWW00T1dyQUJUS3d5SVZicldEWEFmM0t0UHNhZVBDbTZ1OFVzTFJGR2tSdm14YXRJdUtZaHJ3TzRKTi1jTUxlOGROeXRDcXd3OEQwUnFKRXFwNWk4U001bm5leGJLN0hJVWdpZ1BvZkY4aU1vSDg2Q3EyT1pZa08tc1d6YXQ4SHFPZURxY3M1aGlnQ2U2TWQyNkIxdlhPc1ZLbTVpOXhMdFdtLXdOVVdYdHR6UjVYVVM0VnctMEMzMGlrc2h0dHpyN0h5c1hDN05vVnR4SFBEN1RpeXFvSjd5Y3dIczFuc3VZU0N1OERxMFFSWWdBa01JeWtIb1UyWEVjSW51UjlJZG1IR0dVREc5SmNTVmZGNEo3d3hmRHI1S1oxVUFtdUQ0Z1poVW10VHdub21uRkVvWS1ZQjItVmR3SXFkQmg3OHlpOVNvVWxzZkI4X2tjNVRmRm9KV3RJZW1DX3M4V1hEWHFBMWVQQ2hlREFmUUVpSWx0VkFEUjVmbGZYcmZQQXhLSFJDVXVmVnR6d2hURWVENHlIYlZvSnlLXzltdTFMck5MVzdjN3BwWGxPM1FWb0JEekVBYjd4YUhaWG56bmx4ZEJtd3NydmItOHg0Y1hOOE55d1JZeVVUUlZfbjVaekx0MTBicTNoWGxhRlhtcTVvR09QaTZfZFJjckJlUkJWaklBWDJOaFhxSVZRcGRsejE3R2lJRGJSZGFPREhZbE9JQXdFUWtXXy1FdmtIVDMyUUZ4N2Z2TEg0VGRnZkU5YUF1UHVGUkRFNmZWcVl3Q2ZGR2ZLMnFlY2hCdmRBMUFER0dpeWczMUhpbnZhTm90TVN3bzFaUlJLc3p3ZGRXXzdfTTNyWWNZOHI2cm1EMXl4SHh5bkszb3ktTFNiSzBYbjIxV0IwanFUcHRtNHZqTVZnd21uUnJKMENKQTRxaExnRmNPZ3BKRXBzRC1CSWR0NlRZR0t6NTlha1gyYlgxeVAwVzQ3NlJNdE9EV29hTVdOcC02d0s3LWdaejRLNmk2cUlGMGdCYWw3UWZhMUoxX2JxRHZzTUNYZkRvM2dmc1U2SUlFOThuV0UwX1lGdXNFTmtDRVA4YVpIdlJzdkNVWlpWWXgxWmZqRkFHM0pXSGZPZ3A4SmhNZWQzbnRpN2J4OXBjcUtYRmpCQnUwRHRaRFJHWnIwQk1OWmtEWDdyblFYQktmZFlQV1dSTzJodmdja2YtNXR6d1NQLU5reTVoV2N1eW8wRlYtc1ZUbEw2WmhmaEppSlp1bG00WVh5SWwyaE1oVjZKQlNzRVpZUDZkWlNseUxMM2pSQ0NHOHF3aXpLR1hTR3o5UTZzLVdvSlRCTkZ2TmVxNjZET0I5cU5iM2hqTHo2VU93UEp6TWg4eFdfaU5MVXVMV2ZZZnhwNmZTWGVEeS10U3pWQUgtcmxqdjhCMnpKcHlfT0FkQW1VRUVMc0NzdFFvWk9WRm5qV0IzMFAwcmlkd0tkWUczZnNVbDVOVEhwOXRNQTI4enI0OW42ZjdraHJRWVYtczV4bnJYY1kyc1kxbW5kQmEzQVpDZ0wzb3ByNmlUbkdhUE5fMnJDd0RlTXBmWDVGYjR0cElBNE5IZlJhbW56QjIyaV9JM25mWUpUaXNKbFFtcWZxWjVnRldNUmszV05CNTh2VjFUd0V1MnpvcXZkRk5UdFU0dEtsZTNqNVVONk1jLXFsbVEtRG1fLWFQSGRXbmdPd1dVb1dHLXBBbW1IcUstSnRrNFJjWEFGRnlreGh4MXEtX3hBSlBFTkMzMUxHeWFCbUlJdFBOUjdXck5GWjZ4ckFDdFRxd0cyVWQwczNVNjFqNjJnaXJHMWNpemZLcHh6NjB1enEyZ0EycjJWU2xDQ0E5Nks0TG1jUEtSb3NxTjdIMjQ4MVVLY3ctdXA3VlFXbWFKQlU5WENRWGsyNWtjZXR6UmJDcHNqRmpEWkFOZ2Q1U202SVNjR2U0R1ZfdGpObjFaNlJOZzVkV2pvVXhHYmFtZVZJZnhlN3hsd00ybnlOV2FzcWZaT2E5QWR6QVUzZ3ZNc3BVRkxyamo1Z0drYllncl9Sdm42NEhoanlmY210dHFoc1I5WWx2aTVxcGdyTlQ0dVV0YnhFa0czODI1eUtzaXpSQW5BQkFaeW1ZMjhMUFp5RHBYWTBtMlVIWVVmRlNVb05ZWkE2YXhqUjRoZ2Y3dFgzZjl1emV4Mnk2TlBhZkN0N0JMRDZvclRWXzVkMlZPOFgwc3BBYVE0UXFnZGQtalpvcElzMUZaQUVrZ2ZudWJzUEZMdEVUaEt6OHFHOW4zbzd5TDA0LVd4MTlZNHV6NWpiWG5FTmRuTkdOeU5vUmNUODNKbllLWUZRWUp4NW9UWWN4dkhWZ2VJWUFpdjFONHlSTTFPSm1waVluZGZMQVhLRjJKMFc3OGVfYklEdVVMcU9mVEJkMlAwUWlVQjNyenh0WDA4Z0oyclR0RFo3RDh6NDFueXVqX2xVbjFUelBVdXYzbHUwSWRpclJIOVhOMmdvQldPV082d3puN0FBYVJSQ3ljOUZuUUIwT3pMZmY4dVVaUnEwczZiWHB6Y29FR25PUEdZc2g1Nlc0R0tMNHdBYWVTaFZsZndMV2pPbGY3U2RQaGRzZUxTVTlfanBKWU5CVTBySUlVWml6Z2VoZlliOFNnME9SdmdLdXZPWTNaUEpIcG9yMVpTQk5BRTh0YTV2WC16enpWSG80eFpLQ0JRT3BDZGdBMnpHQ191aFQzWUxMSlV4bTlDNVFlUmYwbTNQSjlMWWVWMDFjbnVKWGtmT3ZzWERwRFUtZjRoSlI2eVlVQVFWMlVCdXZZSEtvdEpxR3lzUkxEa1AzLS1RWGZBNHcxVk92dEI0b2tobGl5UWJ5V2ZYWF9SX3ZNQjBhd2FPZXNhc191a203ZFU4Qkw2U2lOV0lGTXg5eDI0UFBVakQ3RlhxN2ZUSkhZWEFPOGJ6bHIxLWRodlFRaFNUYXhTbmJIU0dsZ3JVNjVrbmdHLWtRNG5ueTh6WnhmQk9aMVNfSVNQQXJMbmc3bEZxdDlwRHd4UHZsYzRidE5lVzdDbUJDS2FtbmUzNzRrb2xfUTZsbzdfY2ZBUldaYVpIVklTUlFFS2tvV21ZbWdubU5jeW5ubGkwWnhjNy1YVFlDdjhzYlkxZFBZODIwVDlWYnVoeUYtdE5Id2hycmM0SVAwdGdKNDJ1a0ltNFlCNm45bVlTSnBBeUJJX0x4WmNWdElFZ0Nhc1d5UUd1OTJtbEVkc0dxMWV3SGUyd1lJcU5aVHFNX1hkYk1DSmRxajZabnFiZFdoak1GOGN0X1M3U1pPTlFMdjNRVTlsd3pFcC0wVlFCbGxaR3BJVDR4RTg1cE9EQXd1anBiTWNRa2w1VlBIYVdMMzE4cFdNY3lUWVNWeG5CR0FnWllKWGQ4c1VicWRmdjg0RkdKSnQwdnBXN0dIRjNYWnBlQ0JlQUZYWFJQRUNCRVRQazBBeEtOQ2dyYllnM1RHdC1DMm1kc25mQnRqdjk1dzN1cU1WdHdqUjlfME5nQzdleFJ1MXBLLWhreHY5U3lySjJEOUE5dGxGZWI2MmFLbHliRTN4aS1EVWd5U1I2MHNDb0pkSnp4c2g0UUtYZFZlRXlhLWZGeG8tS2xoVm1xZTlBanljSDM1VFp1MzdOb1A0OC1fbWpxbklybzVfNWlnb1U1TkZZVW11R2xHVl93dU9JSXl1dmZCbDdIUTlJNDlILWpWSUNsbkhReDc0cks1aWg2dy13SFFSNkdtLTlWOERLUHdSaG4xcWh3bGZWdWMwb0pUUk9JNFBaRUYzbFBmSDlpWFdCOXZjb2tIX0JqS0pjU2VY) # <-- Put your encrypted Certificate Private Key here 
        BUNDLE_ID: "com.example.demoCodemagicSimulator" # <-- Put your bundle id here
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
        script: |
          keychain initialize
      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_ADHOC --create
      - name: Use system default keychain
        script: |
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get
      - name: Flutter analyze
        script: |
          cd . && flutter analyze
      - name: Flutter unit tests
        script: |
          cd . && flutter test
        ignore_failure: true          
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log