workflows:
  ios-workflow:
    name: iOS Workflow
    # instance_type: mac_mini
    max_build_duration: 120
    environment:
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"                
        # https://docs.codemagic.io/code-signing-yaml/signing-ios/
        APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmhKaDF2TDQ3WFN0c29rd2lVeXV5elhRS3htNDZjUU9ZZUt2bk5lZmFldnplSDNQd1FMaFluVWJ6djM2ZDlOa1ZDUkdnYXVVcmpDekJPdU94RDZzRDFxcVNqSVRqdnlJTUhuUVJvaVY3TjZieTJkVHdWUEcxQ0d5UFZLQ050emhIcjd6OGQ=) # <-- Put your encrypted App Store Connect Issuer Id here 
        APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmhKa1BBcjBhOHVxcklHcVY1aEJLbDlCNzZJRUtYNGx5QXBBOURyQ0x1WVFFNXpvYmF5YXNabk5BYzFES1ZQTjhKWjlSWEt0bGFsak5YWS1ldDl4RFZJSG5Bb3c9PQ==) # <-- Put your encrypted App Store Connect Key Identifier here 
        APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhKa2pEVzg1dlUxenpYaDdXTHJWSmFIaDl6ckkxYklaUG5MdUJKSUREMFVBTkV4X0lWOFR2ZVlJOUw4b1gwdnpVVExCUFJESHYxdkJxalRwZUtlcFkzQTczb24xRnppZWUyT2xCaDZ1ck1kM05tdjVwbk9DclJHR0dYRHd0bjlyemdYWkVDeEllbTBZZkxCU1FjeE9PWnF5RXM1ZDk3N25VRkl0eURpQ2l3Y3JzVlhSOTRYUElad281eVpBYUhyV0M3M3FEanhJZzR3Z1lUbGcwWTBoUTlnS3N1a1lQYnBIZ1QwUWpERVYtN1Mxd0Vnam1sWm0yRklLcEhVMTFkMDczdHdhOFFqQ205VVJ0UHRaYzNZVS05a1lfZ1VYVDZQN254NER6UnVDZk8tVjRudEJiUk92d0JlSnItTGVQTS1RQk5SQy1JaXo1THFYcmdRejQ5SEhHUFE3ZkhYdnpTRGFPekh0VXVVaXhEbVRXaURzUkpQX0xWaHZQNGZOM0F6NmhQNVM5Um9yZFVQQ05JVlprMkIyQlRhOC1MSkNzNkFFa291UnlXYnRhMklOUGtvWT0=) # <-- Put your encrypted App Store Connect Private Key here 
        # APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmhKa1hTb3ZSTE16WXRXNFFxalhSVGw5cU51WWFDWElMaUhNNjBmeGE1SlJjSXFvOEN4M25iYU1IZi1IckQ5dU9NanJuVWpYdzcxN0tYa1BqY3FKbG1UTVkxcXc9PQ==)
        # APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhKa1dUTmJjTFpHZlQxZGVFeWo0YVhxajJha3lGZFRWR3BGdVVGUHo3N1EyWWsyWmEwbXZZOVlpRDRScGVJOTNRbTVzR3NqTEFCOHlUdXViVzNqWnphUEhZNkRHQVVZN2VwbmlKeFJBb2x6bGU0VU91clJpMVRGbkFJdXpMMEdrWEM4NWVmcVFyMGhpRWlMVDZjamNtbC14SEVKNEd1NVVwMkJXbXI2cGdoTHlweUtwdy1ERnh0OFNGaGIyZVZ6Ykl2d3R6NHo4S2RjRzRldnhfQkFkNW5rdTczT1NZMi1Ec2p4RHBseXExeWo2SE5uVFRBREZ3WVlTSW5xYnBvOWhsdUI0MHhEWS1ibmN6MkNLek5CZVlYN0J6Sk85Q0lqN2g4OWNUN1VoTTlwVDdqV2RVNEZWeGxKY1lsU05yREZOYTlHeXdXb3owN0doWkZPUXFYZ25CcDZqQk9idDd2bjdvMVpjRmFKUno4Mm5wdDlJbUNmajhWOGN1LUZaRkdUZzhzVjl5aERwSTh6V0NQN0Q4bzBPdzNOelpqN0FyZk9hYVpGa2FWMHRkMVM0N0JYZlAwRzgyX0dsWXRIek5VUFRveEJvSmhsTk1SalVhbUVHeWJrWnc0UkdsTnI0NG9WM01FNHQ4ZWZVVmJaSXhyQVdzdmZ2bDI2UTVVRG1fZm93cURTQmVlUE1MR095NUt1cnUzcGZYQXZ4TDZBPT0=)
        CERTIFICATE_PRIVATE_KEY: Encrypted(Z0FBQUFBQmhKa29qeGtCWkJ0SngtdXdGU3doYkFHYXpTeW9xNDdfRWlsQzlFTGZTRmNUZndxVldYYUV2RlhzQ2Q1c19oX3pRYWpxRDFUTGtYdlpiS0YxbE04RHBPdy04UTJfYkdjblJMYU5lMm5wQXU3LTMxaGF3R0FWMjZ5SUkycm4xa2VPZmJrOHlQN2dGcDdxTnlDY2hxdTZQMTdlR3QtLW8zMzMtWkhMMFNQTUdQeFRJUUZZSkVBVUozT3Z4LWNybTdDZGxLc1pXOGV4elRra3MtVHVzSzU0c1hVczN5eDNTa0lyaDBwOWRXLTIyTk54RFNFUVpRSXlGSDU1b2syN0ltaHVucGJJVXpGQ1NKOHpZWmpweHh2STliTlJOQjZ1anp5eWdqMnNXYldVWVp0Y2pCN3g0clNYTXlvcHY5X2JPT3Ayb0tmT1R3OGFicWNtQzRUazNhamJWNzJlaDRIZkZyYkh0dlVSVXpKTjdEZUJEdi1ndU5lbTJCS1gxRElWYm9sZ2NEbDFEeGhwSlhGUHh0S3dranFlSHFfN2RQcnlNNDdZVC01djhSQlliMzVWLWk2YjJ4V0dSa0VHU1RkVFdYa0xwWERwY1pNdWpZTHVfLUVnNjFJMUhQMnlZSjBBM1lvZS1GZERleHpGYldncE9CQ2h3RDRpaUkyVHZlb01NZ3lDNzVwUzBhaFIyZlB5cWVKNXcxLW1pd1lENjNGRW9iY2pQT3RocVp2dmw3RmV1aTBCSEIzYTdFbXRSczNaY2lLUkxLLVBkZ0MtcVh0RG1SX1A5VVh5Rk9QeElGQXJuZWo1eVRGMG05dThlR3IzNzdFaDYzZElOWExkVGdjR1pHajcyYVdEQ0pqLWZlaWxzTjEzUmRueHEtVkdpQkNvV1FoSjBUTkEzb2RGSWNaVUZzMGNQMHhNTVBEVG1aTG1aeVJSeUIwXzhBU3UtZVpTaGdKS3ZmR0dlOHFQN2xWeVVjZ2VHVzRsWEc5ZUhzZFNTczBXajlac0ZhNUpEaU1hdFJram5NVDFJMUMzSUluNE1zYmNPVnlpOU1Cc194TzFwdFJvNVVGa0VfQmlEVFF2X1NfZ1Zxem9JRDNFR09jNnJIZnd0c05VTVpMbF9ZdHZ4R1dTaFFVaTBGTEtDTTktR19YelI2cG9OM081QzhJUlBTd29XQnpiZXpTZ0hWbFQ4aVBWeE15RlFLYkZIVzN6Z3E3YXBBZm4td1JXckFoSlh3em9oNHhXMTBlNjVFUWhpYmc5NHpQc0JPZHdqUDRxRWNJNTlkdFRoZkVtMTNkbUZwVF9ZS2ZnX0VCcVRjbnlZZnlEaFpadnB5WjJ5ZmQ0VDlCQlBPODI4Q0tyVHU0QlNuOTd6d2VyR2JwVFFhRmtnLW9ZZVFFLW1wbUd6OUdYUmN3a3E0SFpwb01MQXFMNmNXTkxsbUlRT28xcTFVdmxCQ1QxemVZeGtlTzFHaFBDazFvVm5YeVlmNWVOUHI4R3IwYTcwOUI2VUhheFBGclZ3NVpWZ1piUVlqOHhnajdsdlRGbU1aRHlmTHg0QVQtd1NTeXZIeXpuODVJYzZhMlZ4LXlfMjVwelJuS05BeDFPbGk0ajJxMnBfVFhoYkN4c1p3NWRVakRiTXB0dEhwUllMRFRma1R1aFBaSjZEbE5HeGRVdzVuVlNndE5xWWh0a0M4NDhFUWR6SUc2MF9uNTZVcFdqaFZNWC1fSGxsMklwdC1VN0F6OFNyVFY5VFhxOC0wVFpRSExzNnlHZnJ6T3lnZGRwekZXbjNjVmYyNGNWalVTVzNCQUxsZk11RURZcTF0b0dqUGJ3REp2WTVsSVFYRkhIdGdwS1hzRHBvUEhsQmlHdWtUdXBKR0NyLWhqaVVGNXRUTUotUDNUOHNZdy1tRldxVzFwLXlYLU9tUFNzbEh0M1hKWjI1Z1hJSFNQNVlRWkR1WkhOZVZDOHJzbWZFVkQ2WDdIM0VmajlkYlFIaDU5MTYxazdwYy1kSnJDUzJjdElLX1JtQUFRY3hJTGpnT05vQ0J0Szhqei1xOHJmZTljMTdhd1o0SVVvSXk2dDB2SkNsV3FDakM3NHRCdU5MUjBZWllkYmxmQ3UzZVg4ZW5tb0ZSVU91bndzV1E0eEFoTk9yODB6S2QxYklaby16enEtSHRtdkVvVFROMHdDN1loRTJ5LWtTblAzb1ItRGM5YkpaZkRmZk0yREJXSkdjYXhzcmw5TjkxdnB2bjYyLXRlb25pZDZBT3NTLUtlQ2hhRG5PS3l5dVhVLUNXMmYwZXRob2J6UzRZWDBfVGNFQ0VJclVEMjVUU21tMlBhZjlNUWNlUmQwQXZKd3dpTHhaeW9fT001X1Y4S0hiNEZaYmhQbHZhNW5KVWRUSlFZOFF1ZlJ3MW1mTEc3N1pHMFhRZzJzOTU4NHpuakFtNkJCUGFCLTllV084c09hLUREVHVNbzFtNllmazgxbXVRQk8yb0lNX05MMlpCZUczbkVrbFFMekNUVWlHM2tjSjZBeFlyeXBjM0laMmw4d1lIaGtMNUxXYWtzRndibkZLVjBMWS02dVVyVzJUd3BzTFE5Z0xoQXc3REtwd2NTRDczZzJlb01iOFpBOGNtbVVrUXhaSm82ck5YYnNpS0pPcFd5NFVZS0ZfS2hwMG1ZUUtiaDJwSzJQWGY4enV4dng1Um41TnVmVWVDYkJzQU1sUW1ablRFclZRckRiVVMxSDRwS3lYX3NoYkktWU9DbWd5X2NBeTRjU1BHN2ZuNWg2U3NRWjlGcnZqbjVXY1UxY3diX3YyTTVLZUNLZU9ZMVVIOU53VmR3Njd5d0U1Q24zQ1ZReEc4NVo1RUJ6RVg1YjI4TTVDSi1vLTlONjVhY3pEQXR4X0ZMOEJzR1JCWWRCLVl4ajhtRmwwdHJ1aFZvQVRaU181NmgtRmF0VVBLSGItNl9KWTRiVkFXal9xUWhXUVFINzd3MFpvT2NKV1NseHhQZ09WWWJEcE1iTEYzM1dFVks4alh0c3RlUkZzRHVhd19ZU29OcmluOUVnQ085djNycGtwdWhsZVhmWjR4MEFpV2pYY1d0d1hhMkow) # <-- Put your encrypted Certificate Private Key here 
        BUNDLE_ID: "com.example.demoCodemagicSimulator" # <-- Put your bundle id here
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Set up keychain to be used for codesigning using Codemagic CLI 'keychain' command
        script: |
          keychain initialize
      - name: Fetch signing files
        script: |
          app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_ADHOC --create
      - name: Use system default keychain
        script: |
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          cd . && flutter packages pub get
      - name: Flutter analyze
        script: |
          cd . && flutter analyze
      - name: Flutter unit tests
        script: |
          cd . && flutter test
        ignore_failure: true          
      - name: Install pods
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log 
      